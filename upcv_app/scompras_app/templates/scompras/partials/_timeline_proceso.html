{% load custom_filters %}
<div class="pc-timeline mt-3">
  <div class="pc-timeline-header">
    <div>
      <h5 class="mb-1 text-dark">Proceso de compra</h5>
      <small class="text-muted">Seguimiento por pasos</small>
    </div>
    <div class="pc-timeline-actions d-flex gap-2">
      {% if es_admin_proceso %}
      <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAsignarAnalista">
        Asignar analista
      </button>
      <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAsignarTipo">
        Asignar tipo de proceso
      </button>
      {% endif %}
    </div>
  </div>
  <div class="pc-timeline-body">
    {% if not solicitud.tipo_proceso %}
      <div class="alert alert-info mb-0">Tipo de proceso en análisis.</div>
    {% else %}
      <div class="timeline-track">
        <div class="timeline-track-bg"></div>
        <div class="timeline-progress-fill" style="width:0%"></div>
      </div>
      <div class="timeline-steps d-flex flex-wrap justify-content-center gap-2 mt-3 position-relative">
        {% for paso in pasos_catalogo %}
          {% with estado=pasos_estado|get_item:paso.id %}
            {% if estado and estado.completado %}
              {% with estado_label="Completado" estado_clase="completed" estado_icono="✓" %}
                <button
                  type="button"
                  class="timeline-step {{ estado_clase }}"
                  data-bs-toggle="modal"
                  data-bs-target="#modalPaso"
                  data-bs-placement="top"
                  data-bs-html="true"
                  data-tooltip="true"
                  title="<div><strong>Paso {{ paso.numero }}</strong></div><div>{{ paso.titulo }}</div>{% if paso.duracion_referencia %}<div>Duración: {{ paso.duracion_referencia }}</div>{% endif %}<div>Estado: {{ estado_label }}</div>"
                  aria-label="Paso {{ paso.numero }} - {{ paso.titulo }}. Estado: {{ estado_label }}"
                  data-step-id="{{ paso.id }}"
                  data-step-numero="{{ paso.numero }}"
                  data-step-estado="{{ estado_label }}"
                  data-paso-id="{{ paso.id }}"
                  data-paso-titulo="{{ paso.titulo }}"
                  data-paso-numero="{{ paso.numero }}"
                  data-paso-nota="{{ estado.nota|default_if_none:'' }}"
                  data-paso-completado="{% if estado and estado.completado %}1{% else %}0{% endif %}"
                  style="animation-delay: {{ forloop.counter|add:-1 }}0ms"
                  {% if not puede_editar_proceso %}disabled{% endif %}
                >
                  {{ estado_icono }}
                </button>
              {% endwith %}
            {% elif paso.numero == solicitud.paso_actual %}
              {% with estado_label="En curso" estado_clase="current" estado_icono=paso.numero %}
                <button
                  type="button"
                  class="timeline-step {{ estado_clase }}"
                  data-bs-toggle="modal"
                  data-bs-target="#modalPaso"
                  data-bs-placement="top"
                  data-bs-html="true"
                  data-tooltip="true"
                  title="<div><strong>Paso {{ paso.numero }}</strong></div><div>{{ paso.titulo }}</div>{% if paso.duracion_referencia %}<div>Duración: {{ paso.duracion_referencia }}</div>{% endif %}<div>Estado: {{ estado_label }}</div>"
                  aria-label="Paso {{ paso.numero }} - {{ paso.titulo }}. Estado: {{ estado_label }}"
                  data-step-id="{{ paso.id }}"
                  data-step-numero="{{ paso.numero }}"
                  data-step-estado="{{ estado_label }}"
                  data-paso-id="{{ paso.id }}"
                  data-paso-titulo="{{ paso.titulo }}"
                  data-paso-numero="{{ paso.numero }}"
                  data-paso-nota="{{ estado.nota|default_if_none:'' }}"
                  data-paso-completado="{% if estado and estado.completado %}1{% else %}0{% endif %}"
                  style="animation-delay: {{ forloop.counter|add:-1 }}0ms"
                  {% if not puede_editar_proceso %}disabled{% endif %}
                >
                  {{ estado_icono }}
                </button>
              {% endwith %}
            {% else %}
              {% with estado_label="Pendiente" estado_clase="pending" estado_icono=paso.numero %}
                <button
                  type="button"
                  class="timeline-step {{ estado_clase }}"
                  data-bs-toggle="modal"
                  data-bs-target="#modalPaso"
                  data-bs-placement="top"
                  data-bs-html="true"
                  data-tooltip="true"
                  title="<div><strong>Paso {{ paso.numero }}</strong></div><div>{{ paso.titulo }}</div>{% if paso.duracion_referencia %}<div>Duración: {{ paso.duracion_referencia }}</div>{% endif %}<div>Estado: {{ estado_label }}</div>"
                  aria-label="Paso {{ paso.numero }} - {{ paso.titulo }}. Estado: {{ estado_label }}"
                  data-step-id="{{ paso.id }}"
                  data-step-numero="{{ paso.numero }}"
                  data-step-estado="{{ estado_label }}"
                  data-paso-id="{{ paso.id }}"
                  data-paso-titulo="{{ paso.titulo }}"
                  data-paso-numero="{{ paso.numero }}"
                  data-paso-nota="{{ estado.nota|default_if_none:'' }}"
                  data-paso-completado="{% if estado and estado.completado %}1{% else %}0{% endif %}"
                  style="animation-delay: {{ forloop.counter|add:-1 }}0ms"
                  {% if not puede_editar_proceso %}disabled{% endif %}
                >
                  {{ estado_icono }}
                </button>
              {% endwith %}
            {% endif %}
          {% endwith %}
        {% empty %}
          <div class="text-muted">No hay pasos configurados para este tipo.</div>
        {% endfor %}
      </div>
      <div class="pc-timeline-legend mt-3 d-flex flex-wrap gap-2 justify-content-center">
        <span class="pc-pill pc-pill-success">✓ Completado</span>
        <span class="pc-pill pc-pill-primary">● En curso</span>
        <span class="pc-pill pc-pill-neutral">○ Pendiente</span>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .pc-timeline {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(15, 23, 42, .06);
    padding: 20px;
  }

  .pc-timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 12px;
  }

  .pc-timeline-actions .btn-outline-primary {
    color: #0068ab;
    border-color: #0068ab;
  }

  .pc-timeline-actions .btn-outline-secondary {
    color: #064b78;
    border-color: #064b78;
  }

  .pc-timeline-body {
    padding-top: 16px;
  }

  .timeline-track {
    position: relative;
    height: 6px;
    margin: 0 auto;
    max-width: 720px;
  }

  .timeline-track-bg {
    position: absolute;
    inset: 0;
    background: #e5e7eb;
    border-radius: 999px;
  }

  .timeline-progress-fill {
    position: absolute;
    inset: 0;
    width: 0%;
    background: linear-gradient(90deg, #0068ab, #198754);
    border-radius: 999px;
    transition: width .3s ease;
  }

  .timeline-steps {
    min-height: 40px;
  }

  .timeline-step {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    position: relative;
    transition: transform .2s ease, box-shadow .2s ease;
    padding: 0;
    animation: pcFadeUp .35s ease both;
  }

  .timeline-step:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 12px rgba(15, 23, 42, .18);
  }

  .timeline-step.completed {
    background: #198754;
    color: #fff;
    border: 2px solid #157347;
  }

  .timeline-step.current {
    background: #0068ab;
    color: #fff;
    border: 3px solid #0f172a;
    box-shadow: 0 0 0 3px rgba(0, 104, 171, .2);
  }

  .timeline-step.pending {
    background: #e5e7eb;
    color: #0f172a;
    border: 2px solid #e5e7eb;
  }

  .timeline-step.inactive {
    background: #fff;
    border: 2px dashed #e5e7eb;
    color: #64748b;
  }

  .pc-timeline-legend .pc-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid #e5e7eb;
    background: #fff;
    color: #0f172a;
  }

  .pc-pill-success {
    border-color: rgba(25, 135, 84, .3);
    color: #157347;
  }

  .pc-pill-primary {
    border-color: rgba(0, 104, 171, .3);
    color: #0068ab;
  }

  .pc-pill-neutral {
    border-color: rgba(100, 116, 139, .3);
    color: #475569;
  }

  @keyframes pcFadeUp {
    from {
      opacity: 0;
      transform: translateY(6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .timeline-track {
      display: none;
    }
  }
</style>

{% if es_admin_proceso %}
<div class="modal fade" id="modalAsignarAnalista" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Asignar analista</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formAsignarAnalista" data-url="{% url 'scompras:asignar_analista_solicitud' solicitud.id %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Analista</label>
            <select name="analista_user_id" class="form-select" required>
              <option value="">Seleccione...</option>
              {% for analista in analistas %}
                <option value="{{ analista.id }}" {% if solicitud.analista_asignado_id == analista.id %}selected{% endif %}>
                  {{ analista.get_full_name|default:analista.username }}
                </option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="formAsignarAnalista" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalAsignarTipo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Asignar tipo de proceso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formAsignarTipo" data-url="{% url 'scompras:asignar_tipo_proceso_solicitud' solicitud.id %}">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Tipo</label>
            <select name="tipo_id" id="tipoProcesoSelect" class="form-select" required>
              <option value="">Seleccione...</option>
              {% for tipo in tipos_proceso %}
                <option value="{{ tipo.id }}" {% if solicitud.tipo_proceso_id == tipo.id %}selected{% endif %}>
                  {{ tipo.nombre }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Subtipo</label>
            <select name="subtipo_id" id="subtipoProcesoSelect" class="form-select">
              <option value="">Sin subtipo</option>
              {% for subtipo in subtipos_proceso %}
                <option value="{{ subtipo.id }}" data-tipo="{{ subtipo.tipo_id }}" {% if solicitud.subtipo_proceso_id == subtipo.id %}selected{% endif %}>
                  {{ subtipo.nombre }}
                </option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="formAsignarTipo" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="modalPaso" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalPasoTitulo">Actualizar paso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formPaso" data-url-template="{% url 'scompras:toggle_paso_solicitud' solicitud.id 0 %}">
          {% csrf_token %}
          <input type="hidden" name="paso_id" id="pasoIdInput">
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="pasoCompletadoInput">
            <label class="form-check-label" for="pasoCompletadoInput">Marcar como completado</label>
          </div>
          <div class="mb-3">
            <label class="form-label">Nota</label>
            <textarea name="nota" id="pasoNotaInput" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" form="formPaso" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  };

  const handlePostForm = (form, onSuccess) => {
    const url = form.dataset.url;
    const formData = new FormData(form);
    fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData,
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        onSuccess();
      } else {
        alert('No fue posible guardar los cambios.');
      }
    })
    .catch(() => alert('No fue posible guardar los cambios.'));
  };

  const asignarAnalistaForm = document.getElementById('formAsignarAnalista');
  if (asignarAnalistaForm) {
    asignarAnalistaForm.addEventListener('submit', (event) => {
      event.preventDefault();
      handlePostForm(asignarAnalistaForm, () => window.location.reload());
    });
  }

  const asignarTipoForm = document.getElementById('formAsignarTipo');
  if (asignarTipoForm) {
    asignarTipoForm.addEventListener('submit', (event) => {
      event.preventDefault();
      handlePostForm(asignarTipoForm, () => window.location.reload());
    });
  }

  const subtipoSelect = document.getElementById('subtipoProcesoSelect');
  const tipoSelect = document.getElementById('tipoProcesoSelect');
  const filtrarSubtipos = () => {
    if (!subtipoSelect || !tipoSelect) return;
    const tipoId = tipoSelect.value;
    Array.from(subtipoSelect.options).forEach(option => {
      if (!option.value) return;
      option.hidden = option.dataset.tipo !== tipoId;
      if (option.hidden && option.selected) option.selected = false;
    });
  };
  if (tipoSelect) {
    tipoSelect.addEventListener('change', filtrarSubtipos);
    filtrarSubtipos();
  }

  const modalPaso = document.getElementById('modalPaso');
  if (modalPaso) {
    modalPaso.addEventListener('show.bs.modal', (event) => {
      const button = event.relatedTarget;
      if (!button) return;
      const pasoId = button.getAttribute('data-paso-id');
      const titulo = button.getAttribute('data-paso-titulo');
      const numero = button.getAttribute('data-paso-numero');
      const nota = button.getAttribute('data-paso-nota') || '';
      const completado = button.getAttribute('data-paso-completado') === '1';

      document.getElementById('modalPasoTitulo').textContent = `Paso ${numero}: ${titulo}`;
      document.getElementById('pasoIdInput').value = pasoId;
      document.getElementById('pasoNotaInput').value = nota;
      document.getElementById('pasoCompletadoInput').checked = completado;
    });
  }

  const formPaso = document.getElementById('formPaso');
  if (formPaso) {
    formPaso.addEventListener('submit', (event) => {
      event.preventDefault();
      const pasoId = document.getElementById('pasoIdInput').value;
      const urlTemplate = formPaso.dataset.urlTemplate;
      const url = urlTemplate.replace('/0/', `/${pasoId}/`);
      const formData = new FormData(formPaso);
      if (!document.getElementById('pasoCompletadoInput').checked) {
        formData.append('completado', '0');
      }
      fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData,
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('No fue posible actualizar el paso.');
        }
      })
      .catch(() => alert('No fue posible actualizar el paso.'));
    });
  }

  const initTooltips = () => {
    if (typeof bootstrap !== 'undefined') {
      const tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-tooltip="true"]')
      );
      tooltipTriggerList.map((el) => new bootstrap.Tooltip(el));
    }
  };

  const updateTimelineProgress = () => {
    const timeline = document.querySelector('.pc-timeline');
    if (!timeline) return;
    const steps = timeline.querySelectorAll('.timeline-step');
    const fill = timeline.querySelector('.timeline-progress-fill');
    if (!fill || steps.length === 0) return;
    const completed = timeline.querySelectorAll('.timeline-step.completed').length;
    const currentStep = timeline.querySelector('.timeline-step.current');
    let progressPercent = 0;
    if (currentStep) {
      const currentIndex = Array.from(steps).indexOf(currentStep);
      const total = steps.length - 1;
      progressPercent = total > 0 ? (currentIndex / total) * 100 : 0;
    } else {
      progressPercent = (completed / steps.length) * 100;
    }
    fill.style.width = `${Math.min(100, Math.max(0, progressPercent))}%`;
  };

  let resizeTimer;
  const handleResize = () => {
    window.clearTimeout(resizeTimer);
    resizeTimer = window.setTimeout(updateTimelineProgress, 150);
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initTooltips();
      updateTimelineProgress();
    });
  } else {
    initTooltips();
    updateTimelineProgress();
  }

  window.addEventListener('resize', handleResize);
</script>
